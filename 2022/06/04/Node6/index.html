<!DOCTYPE html>
<html lang="zh-CN" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="" />
  <meta name="author" content="不知名小白菜" />
  <meta name="description" content="" />
  
  
  <title>
    
      http内置模块，Express和Koa 
      
      
      |
    
     Hexo
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  
<link rel="stylesheet" href="/css/color-scheme.css">
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css">
<link rel="stylesheet" href="/css/github-markdown.css">
<link rel="stylesheet" href="/css/highlight.css">
<link rel="stylesheet" href="/css/comments.css">

  <!-- 代码块风格 -->
  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
<meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img src="/images/avatar.png" alt="">
      
    </a>
    <div class="nickname"><a href="/">Oranges</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">About</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="/plugins/mathjax/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="/plugins/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">http内置模块，Express和Koa</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime" title="更新时间"></i>
          2022-06-04 01:47:14
        </span>
        
              <span class="post-tags">
                <i class="iconfont icon-tags" title="标签"></i>
                
                <span class="span--tag">
                  <a href="/tags/Node%E5%AD%A6%E4%B9%A0/" title="Node学习">
                    <b>#</b> Node学习
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <h2 id="http内置模块，Node框架Express和Koa"><a href="#http内置模块，Node框架Express和Koa" class="headerlink" title="http内置模块，Node框架Express和Koa"></a>http内置模块，Node框架Express和Koa</h2><h3 id="http模块"><a href="#http模块" class="headerlink" title="http模块"></a>http模块</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">const http = require(&#x27;http&#x27;);</span><br><span class="line"></span><br><span class="line">// 创建一个web服务器</span><br><span class="line">const server = http.createServer((req, res) =&gt; &#123;</span><br><span class="line">  res.end(&quot;Hello Server&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// 启动服务器,并且制定端口号和主机</span><br><span class="line">server.listen(8888, &#x27;0.0.0.0&#x27;, () =&gt; &#123;</span><br><span class="line">  console.log(&quot;服务器启动成功~&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">如果没有输入端口号，可以通过server.address().port获取</span><br><span class="line">server.listen(() =&gt; &#123;</span><br><span class="line">  console.log(&quot;服务器启动成功~&quot;);</span><br><span class="line">  console.log(server.address().port)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">listen函数有三个参数</span><br><span class="line">端口port，可以不穿，系统默认分配</span><br><span class="line">主机host，通常是localhost，ip127.0.0.1，或者0.0.0.0，默认是0.0.0.0</span><br><span class="line">localhost本质上是一个域名会被解析成127.0.0.1</span><br><span class="line">127.0.0.1是回环地址，自己主机发出去的包自己解析，在应用层 =&gt; 传输层 =&gt; 网络层 =&gt; 链路层 =&gt; 物理层</span><br><span class="line">在网络层就会被获取，不会经过链路层是物理层</span><br><span class="line">0.0.0.0监听所有IP地址，再根据端口找到不同的应用程序</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="req"><a href="#req" class="headerlink" title="req"></a>req</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">request包含请求路径，方法和头等</span><br><span class="line">const server = http.createServer((req, res) =&gt; &#123;</span><br><span class="line">	console.log(requrl)</span><br><span class="line">	console.log(req.ethod)</span><br><span class="line">	console.log(req.eaders)</span><br><span class="line">  res.end(&quot;Hello Server&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">url</span><br><span class="line">const server = http.createServer((req, res) =&gt; &#123;</span><br><span class="line">   if(req.url== &#x27;/login&#x27;)</span><br><span class="line">        res.end(&quot;请登录&quot;)</span><br><span class="line">   &#125;else if(req.url==&#x27;/register&#x27;)&#123;</span><br><span class="line">		res.end(&quot;请注册&quot;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">如果访问地址携带参数，利用url模块和qs模块，明文传输方式</span><br><span class="line">const url = require(&#x27;url&#x27;）</span><br><span class="line">const qs = require(&#x27;querystring&#x27;);</span><br><span class="line">  const &#123; pathname, query &#125; = url.parse(req.url);</span><br><span class="line">  if (pathname === &#x27;/login&#x27;) &#123;</span><br><span class="line">    console.log(qs.parse(query));</span><br><span class="line">    const &#123; username, password &#125; = qs.parse(query);</span><br><span class="line">    console.log(username, password);</span><br><span class="line">    res.end(&quot;请求结果~&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">method</span><br><span class="line">拿到通过post请求发送的json数据，不在地址栏</span><br><span class="line">const server = http.createServer((req, res) =&gt; &#123;</span><br><span class="line">  console.log(req.method)</span><br><span class="line">     if(req.methdos == &#x27;POST&#x27;)&#123;</span><br><span class="line">		//获取body数据</span><br><span class="line">		req.setEncoding(&#x27;utf-8&#x27;) //设置数据编码 如果是音频和其他文件就是其他编码</span><br><span class="line">		req.on(&#x27;data&#x27;,(data)=&gt;&#123;</span><br><span class="line">            console.log(data.toString()) //字符串类型 &#123;username:&quot;&#x27;,age:&quot;&#x27;&#125;</span><br><span class="line">            转换成js对象</span><br><span class="line">            const &#123; username, age &#125; = JSON.parse(data.toString())</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">headers</span><br><span class="line">console.log(req.headers)</span><br><span class="line">contenttype：数据类型</span><br><span class="line">content-length：文件长度</span><br><span class="line">connection：keep-alive保持连接</span><br><span class="line">accept-encoding：告知服务器，客户端支持的文件压缩格式，比如js文件可以使用gzip编码。对应.gz文件</span><br><span class="line">accept：告知服务器科技接收的文件格式</span><br><span class="line">user-agent：客户端相关信息</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="res"><a href="#res" class="headerlink" title="res"></a>res</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">response</span><br><span class="line">const server = http.createServer((req, res) =&gt; &#123;</span><br><span class="line">  	1：res.end(&quot;响应结果&quot;)</span><br><span class="line">  	2：res.write(&quot;响应结果&quot;)</span><br><span class="line">  	   res.end()</span><br><span class="line">  	</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">响应状态码</span><br><span class="line">1：需要后续操作</span><br><span class="line">2：OK，成功</span><br><span class="line">3：重定向</span><br><span class="line">4：客户端</span><br><span class="line">5：服务端</span><br><span class="line"></span><br><span class="line">状态码设置方式</span><br><span class="line">res.statusCode = 404</span><br><span class="line">res.writeHead(404,&#123;</span><br><span class="line">    可以传入header相关的事情</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">设置头方式</span><br><span class="line">1：res.setHeader(&quot;content-type&quot;, &quot;text/plain&quot;)</span><br><span class="line">2：res.writeHead(200, &#123;</span><br><span class="line">    &quot;content-type&quot;:&quot;text/plain&quot;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="http发送网络请求"><a href="#http发送网络请求" class="headerlink" title="http发送网络请求"></a>http发送网络请求</h4><p>axios在前端使用时，基于xhr，在node端使用时是基于http模块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">const http = require(&#x27;http&#x27;)</span><br><span class="line">http.get(&#x27;...&#x27;,(res)=&gt;&#123;</span><br><span class="line">    res.on(&#x27;data&#x27;,(data)+&gt;&#123;</span><br><span class="line">        console.log(data) //结果</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">发送post</span><br><span class="line">const req = http.request(&#123;</span><br><span class="line">    method:&#x27;POST&#x27;,</span><br><span class="line">    host:&#x27;localhost&#x27;,</span><br><span class="line">    port:8888</span><br><span class="line">&#125;,(res)=&gt;&#123;</span><br><span class="line">    res.on(&#x27;data&#x27;,(data)=&gt;&#123;</span><br><span class="line">        console.log(&#x27;结果&#x27;)</span><br><span class="line">    &#125;)</span><br><span class="line">    res.on(&#x27;end&#x27;,()=&gt;&#123;</span><br><span class="line">		console.log(&#x27;获取到了所有结果&#x27;)</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">req.end() //必须，否则请求停滞</span><br></pre></td></tr></table></figure>

<h4 id="http方式原生的文件上传"><a href="#http方式原生的文件上传" class="headerlink" title="http方式原生的文件上传"></a>http方式原生的文件上传</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">const http = require(&#x27;http&#x27;);</span><br><span class="line">const fs = require(&#x27;fs&#x27;);</span><br><span class="line">const qs = require(&#x27;querystring&#x27;);</span><br><span class="line"></span><br><span class="line">const server = http.createServer((req, res) =&gt; &#123;</span><br><span class="line">  if (req.url === &#x27;/upload&#x27;) &#123;</span><br><span class="line">    if (req.method === &#x27;POST&#x27;) &#123;</span><br><span class="line">    	//必须，图片编码必须设置为binary</span><br><span class="line">      req.setEncoding(&#x27;binary&#x27;);</span><br><span class="line"></span><br><span class="line">      let body = &#x27;&#x27;;</span><br><span class="line">      const totalBoundary = req.headers[&#x27;content-type&#x27;].split(&#x27;;&#x27;)[1];</span><br><span class="line">      const boundary = totalBoundary.split(&#x27;=&#x27;)[1];</span><br><span class="line"></span><br><span class="line">      req.on(&#x27;data&#x27;, (data) =&gt; &#123;</span><br><span class="line">        body += data;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      req.on(&#x27;end&#x27;, () =&gt; &#123;</span><br><span class="line">        console.log(body);</span><br><span class="line">        // 处理body</span><br><span class="line">        // 1.获取image/png的位置</span><br><span class="line">        const payload = qs.parse(body, &quot;\r\n&quot;, &quot;: &quot;);</span><br><span class="line">        const type = payload[&quot;Content-Type&quot;];</span><br><span class="line"></span><br><span class="line">        // 2.开始在image/png的位置进行截取</span><br><span class="line">        const typeIndex = body.indexOf(type);</span><br><span class="line">        const typeLength = type.length;</span><br><span class="line">        let imageData = body.substring(typeIndex + typeLength);</span><br><span class="line"></span><br><span class="line">        // 3.将中间的两个空格去掉</span><br><span class="line">        imageData = imageData.replace(/^\s\s*/, &#x27;&#x27;);</span><br><span class="line"></span><br><span class="line">        // 4.将最后的boundary去掉</span><br><span class="line">        imageData = imageData.substring(0, imageData.indexOf(`--$&#123;boundary&#125;--`));</span><br><span class="line"></span><br><span class="line">        fs.writeFile(&#x27;./foo.png&#x27;, imageData, &#x27;binary&#x27;, (err) =&gt; &#123;</span><br><span class="line">          res.end(&quot;文件上传成功~&quot;);</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.listen(8000, () =&gt; &#123;</span><br><span class="line">  console.log(&quot;文件上传服务器开启成功~&quot;);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Express"><a href="#Express" class="headerlink" title="Express"></a>Express</h3><h4 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">//安装方式 1 脚手架安装</span><br><span class="line">npm install express-generator -g</span><br><span class="line">expres  demo</span><br><span class="line">npm install</span><br><span class="line">node bin/www</span><br><span class="line">// 默认启动是loaclhost:3000</span><br><span class="line"></span><br><span class="line">// 2自己从0实现</span><br><span class="line"> npm install express</span><br><span class="line">// 引入</span><br><span class="line">const express = require(&#x27;express&#x27;);</span><br><span class="line">// 返回app</span><br><span class="line">const app = express()</span><br><span class="line">//监听请求路径</span><br><span class="line">app.get(&#x27;/&#x27;,(req,res,next)=&gt;&#123;</span><br><span class="line">    res.end(&#x27;hello get&#x27;)</span><br><span class="line">&#125;)</span><br><span class="line">app.post(&#x27;/&#x27;,(req,res,next)=&gt;&#123;</span><br><span class="line">    res.end(&#x27;hello post&#x27;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(5000,()=&gt;&#123;</span><br><span class="line">    console.log(&#x27;开启&#x27;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>express的中间件，中间件就是回调函数，接受req，res，next，next是执行下一个中间件的方法，express本质上是中间件的调用</p>
<p>中间件中可以执行任何代码，更改请求和响应对象，结束请求，响应周期，返回数据，调用栈中的下一个中间件</p>
<p>如果没有res.end就需要next传递给下一个中间件，否则请求会被挂起，不会结束</p>
<p>express提供了两种方式将中间件应用与程序中，app&#x2F;router.use和app&#x2F;router.methods</p>
<p>可以是app，也可以是router，methods是指常用的请求方式app.get或者app.post</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">中间件类型1//最普通的中间件</span><br><span class="line">app.use((req,res,next)=&gt;&#123;</span><br><span class="line">    console.log(&#x27;注册了第一个普通中间件&#x27;)</span><br><span class="line">&#125;)</span><br><span class="line">只会执行一个中间件</span><br><span class="line">app.use((req,res,next)=&gt;&#123;</span><br><span class="line">    console.log(&#x27;注册了第一个普通中间件&#x27;)</span><br><span class="line">    res.end()</span><br><span class="line">    // 想要让第二个中间件执行得</span><br><span class="line">    next()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.use((req,res,next)=&gt;&#123;</span><br><span class="line">    console.log(&#x27;注册了第二个普通中间件&#x27;)</span><br><span class="line">    res.end() // 报错 不能在end之后再end，end只能有一个</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">中间件类型2//path匹配中间件</span><br><span class="line">app.use(path,callback)</span><br><span class="line">app.use(&#x27;/home&#x27;,(req,res,next)=&gt;&#123;</span><br><span class="line">    console.log(&#x27;匹配到了/home&#x27;)</span><br><span class="line">    res.end(&#x27;end&#x27;)</span><br><span class="line">&#125;</span><br><span class="line">如果有相同的path匹配中间件，永远只会调用第一个中间件，除非使用next</span><br><span class="line"></span><br><span class="line">中间件类型3//path和method匹配中间件</span><br><span class="line">app.get(&#x27;/home&#x27;,(req.res,next)=&gt;&#123;</span><br><span class="line">    </span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">中间件类型4//注册多个中间件</span><br><span class="line">app.get(&#x27;/home&#x27;,(req,res,next)=&gt;&#123;</span><br><span class="line"></span><br><span class="line">&#125;,(req,res,next)=&gt;&#123;</span><br><span class="line"></span><br><span class="line">&#125;,(req,res,next)=&gt;&#123;</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">//使用express解析req.body很轻松  解析json</span><br><span class="line">app.use(express.json())</span><br><span class="line"></span><br><span class="line">// true是使用qs解析，false那么就是使用node中的queryString进行解析 解析urlencoded</span><br><span class="line">app.use(express.urlencoded(&#123;extended:true&#125;))</span><br><span class="line"></span><br><span class="line">// 解析formdata</span><br><span class="line">npm install multer</span><br><span class="line">const upload = require(&#x27;multer&#x27;)</span><br><span class="line">app.use(multer.any())</span><br><span class="line">// 上穿文件 设置上传路径</span><br><span class="line">const multer = multer(&#123;</span><br><span class="line">    dest:&#x27;./uploads/&#x27; // 上传文件保存位置,</span><br><span class="line">&#125;)</span><br><span class="line">const path = require(&#x27;path&#x27;</span><br><span class="line">const storage = muliter.diskStorge(&#123;</span><br><span class="line">    destintion: (req,res,cb)=&gt;&#123;</span><br><span class="line">        cb(null,&#x27;./uploads/&#x27;)</span><br><span class="line">    &#125;//目的地，</span><br><span class="line">    filename: (req,res,cb)=&gt;&#123;</span><br><span class="line">        cb(null, Date.now() + path.extname(file.originalname))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">upload.single 上传单个文件 upload.array 上传多个文件 可以传递一个key值表示具体处理哪个数据</span><br><span class="line">app.post(&#x27;/upload&#x27;,upload.single(&#x27;&#x27;) ,(req,res,next)=&gt;&#123;</span><br><span class="line">	console.log(req.files)</span><br><span class="line">    res.end(&#x27;上传成功&#x27;)</span><br><span class="line">&#125;)</span><br><span class="line">// 默认没有后缀名</span><br></pre></td></tr></table></figure>

<h4 id="中间件用法"><a href="#中间件用法" class="headerlink" title="中间件用法"></a>中间件用法</h4><h4 id="json解析"><a href="#json解析" class="headerlink" title="json解析"></a>json解析</h4><p>express内置一些request解析的中间件 ，当客户端发送请求post请求时，会把数据放到req.body中</p>
<p>客户端可以通过json也可以通过form表单的方式传递</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">post 发送username和age</span><br><span class="line"></span><br><span class="line">自己写的</span><br><span class="line">// app.use((req, res, next) =&gt; &#123;</span><br><span class="line">//   if (req.headers[&quot;content-type&quot;] === &#x27;application/json&#x27;) &#123;</span><br><span class="line">//     req.on(&#x27;data&#x27;, (data) =&gt; &#123;</span><br><span class="line">//       const info = JSON.parse(data.toString());</span><br><span class="line">//       req.body = info;</span><br><span class="line">//     &#125;)</span><br><span class="line">  </span><br><span class="line">//     req.on(&#x27;end&#x27;, () =&gt; &#123;</span><br><span class="line">//       next();</span><br><span class="line">//     &#125;)</span><br><span class="line">//   &#125; else &#123;</span><br><span class="line">//     next();</span><br><span class="line">//   &#125;</span><br><span class="line">// &#125;)</span><br><span class="line"></span><br><span class="line">使用express</span><br><span class="line">// 使用express提供给我们的body解析</span><br><span class="line">// body-parser: express3.x 内置express框架</span><br><span class="line">// body-parser: express4.x 被分离出去</span><br><span class="line">// body-parser类似功能: express4.16.x 内置成函数</span><br><span class="line">app.use(express.json()); //传送数据为json格式时 application/json</span><br><span class="line">// extended</span><br><span class="line">// true: 那么对urlencoded进行解析时, 它使用的是第三方库: qs</span><br><span class="line">// false: 那么对urlencoded进行解析时, 它使用的是Node内置模块: querystring</span><br><span class="line">app.use(express.urlencoded(&#123;extended: true&#125;));//传送数据解析application/x-www-form-urlencoded</span><br><span class="line">后续可直接通过打印req.body方式获取传送数据</span><br><span class="line">app.post(&#x27;/login&#x27;, (req, res, next) =&gt; &#123;</span><br><span class="line">  console.log(req.body);</span><br><span class="line">  res.end(&quot;Coderwhy, Welcome Back~&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(&#x27;/products&#x27;, (req, res, next) =&gt; &#123;</span><br><span class="line">  console.log(req.body);</span><br><span class="line">  res.end(&quot;Upload Product Info Success~&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(8000, () =&gt; &#123;</span><br><span class="line">  console.log(&quot;express初体验服务器启动成功~&quot;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="formdata解析"><a href="#formdata解析" class="headerlink" title="formdata解析"></a>formdata解析</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">npm install multer</span><br><span class="line"></span><br><span class="line">const express = require(&#x27;express&#x27;);</span><br><span class="line">const multer = require(&#x27;multer&#x27;);</span><br><span class="line"></span><br><span class="line">const app = express();</span><br><span class="line"></span><br><span class="line">app.use(express.json());</span><br><span class="line">app.use(express.urlencoded(&#123; extended: true &#125;));</span><br><span class="line"></span><br><span class="line">const upload = multer();</span><br><span class="line"></span><br><span class="line">app.use(upload.any());</span><br><span class="line"></span><br><span class="line">app.post(&#x27;/login&#x27;, (req, res, next) =&gt; &#123;</span><br><span class="line">  console.log(req.body);</span><br><span class="line">  res.end(&quot;用户登录成功~&quot;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(8000, () =&gt; &#123;</span><br><span class="line">  console.log(&quot;form-data解析服务器启动成功~&quot;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="formdata上传文件"><a href="#formdata上传文件" class="headerlink" title="formdata上传文件"></a>formdata上传文件</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">const path = require(&#x27;path&#x27;);</span><br><span class="line"></span><br><span class="line">const express = require(&#x27;express&#x27;);</span><br><span class="line">const multer = require(&#x27;multer&#x27;);</span><br><span class="line"></span><br><span class="line">const app = express();</span><br><span class="line"></span><br><span class="line">app.use(express.json());</span><br><span class="line">app.use(express.urlencoded(&#123; extended: true &#125;));</span><br><span class="line"></span><br><span class="line">//自定义的文件信息</span><br><span class="line">const storage = multer.diskStorage(&#123;</span><br><span class="line">  destination: (req, file, cb) =&gt; &#123;</span><br><span class="line">    cb(null, &#x27;./uploads/&#x27;);</span><br><span class="line">  &#125;,</span><br><span class="line">  filename: (req, file, cb) =&gt; &#123;</span><br><span class="line">    cb(null, Date.now() + path.extname(file.originalname));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">const upload = multer(&#123;</span><br><span class="line">  // dest: &#x27;./uploads/&#x27; //文件存储路径</span><br><span class="line">  storage //自定义文件存储信息</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(&#x27;/login&#x27;, upload.any(), (req, res, next) =&gt; &#123;</span><br><span class="line">  console.log(req.body);</span><br><span class="line">  res.end(&quot;用户登录成功~&quot;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">上传单个文件</span><br><span class="line">app.post(&#x27;/upload&#x27;, upload.single(&#x27;file&#x27;), (req, res, next) =&gt; &#123;</span><br><span class="line">  console.log(req.files);</span><br><span class="line">  res.end(&quot;文件上传成功~&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">上传多个文件</span><br><span class="line">app.post(&#x27;/upload&#x27;, upload.array(&#x27;file&#x27;), (req, res, next) =&gt; &#123;</span><br><span class="line">  console.log(req.files);</span><br><span class="line">  res.end(&quot;文件上传成功~&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(8000, () =&gt; &#123;</span><br><span class="line">  console.log(&quot;form-data解析服务器启动成功~&quot;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="保存日志信息"><a href="#保存日志信息" class="headerlink" title="保存日志信息"></a>保存日志信息</h4><p>使用express开发的第三方中间件，morgan，需要单独安装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">const fs = require(&#x27;fs&#x27;);</span><br><span class="line"></span><br><span class="line">const express = require(&#x27;express&#x27;);</span><br><span class="line">const morgan = require(&#x27;morgan&#x27;);</span><br><span class="line"></span><br><span class="line">const app = express();</span><br><span class="line"></span><br><span class="line">const writerStream = fs.createWriteStream(&#x27;./logs/access.log&#x27;, &#123;</span><br><span class="line">  flags: &quot;a+&quot;</span><br><span class="line">&#125;)</span><br><span class="line">//combined是保存的日志格式，</span><br><span class="line">app.use(morgan(&quot;combined&quot;, &#123;stream: writerStream&#125;));</span><br><span class="line"></span><br><span class="line">app.get(&#x27;/home&#x27;, (req, res, next) =&gt; &#123;</span><br><span class="line">  res.end(&quot;Hello World&quot;);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(8000, () =&gt; &#123;</span><br><span class="line">  console.log(&quot;express初体验服务器启动成功~&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="request参数解析"><a href="#request参数解析" class="headerlink" title="request参数解析"></a>request参数解析</h4><p><img src="https://s1.ax1x.com/2022/09/22/xFpDo9.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">const express = require(&#x27;express&#x27;);</span><br><span class="line"></span><br><span class="line">const app = express();</span><br><span class="line"></span><br><span class="line">app.get(&#x27;/products/:id/:name&#x27;, (req, res, next) =&gt; &#123;</span><br><span class="line">  console.log(req.params);</span><br><span class="line">  // req.params =&gt; 在数据库中查询真实的商品数据</span><br><span class="line">  res.end(&quot;商品的详情数据~&quot;);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(&#x27;/login&#x27;, (req, res, next) =&gt; &#123;</span><br><span class="line">  console.log(req.query);</span><br><span class="line">  res.end(&quot;用户登录成功~&quot;);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(8000, () =&gt; &#123;</span><br><span class="line">  console.log(&quot;普通中间件服务器启动成功~&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="response响应结果解析"><a href="#response响应结果解析" class="headerlink" title="response响应结果解析"></a>response响应结果解析</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">const express = require(&#x27;express&#x27;);</span><br><span class="line">const router = require(&#x27;./routers/users&#x27;);</span><br><span class="line"></span><br><span class="line">const app = express();</span><br><span class="line"></span><br><span class="line">app.get(&#x27;/products/:id/:name&#x27;, (req, res, next) =&gt; &#123;</span><br><span class="line">  console.log(req.params);</span><br><span class="line">  // req.params =&gt; 在数据库中查询真实的商品数据</span><br><span class="line">  res.end(&quot;商品的详情数据~&quot;);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(&#x27;/login&#x27;, (req, res, next) =&gt; &#123;</span><br><span class="line">  console.log(req.query);</span><br><span class="line"></span><br><span class="line">  // 设置响应吗</span><br><span class="line">  res.status(204);</span><br><span class="line"></span><br><span class="line">  // res.type(&quot;application/json&quot;);</span><br><span class="line">  // res.end(JSON.stringify(&#123;name: &quot;why&quot;, age: 18&#125;));</span><br><span class="line">  // res.json(&#123;name: &quot;why&quot;, age: 18&#125;)</span><br><span class="line">  // 设置内容</span><br><span class="line">  res.json([&quot;abc&quot;, &quot;cba&quot;, &quot;abc&quot;]);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 举个例子:</span><br><span class="line"> *   请求所有的用户信息: get /users</span><br><span class="line"> *   请求所有的某个用户信息: get /users/:id</span><br><span class="line"> *   请求所有的某个用户信息: post /users body &#123;username: passwod:&#125;</span><br><span class="line"> *   请求所有的某个用户信息: delete /users/:id </span><br><span class="line"> *   请求所有的某个用户信息: patch /users/:id &#123;nickname: &#125;</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">app.listen(8000, () =&gt; &#123;</span><br><span class="line">  console.log(&quot;普通中间件服务器启动成功~&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="路由的使用"><a href="#路由的使用" class="headerlink" title="路由的使用"></a>路由的使用</h4><p>如果将所有代码放在app中，那么app会越来越复杂，可以使用express.Router创建一个路由处理程序，一个路由实例拥有完整的中间件和路由系统，因此也被称为迷你应用程序</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">const express = require(&#x27;express&#x27;);</span><br><span class="line">const userRouter = require(&#x27;./routers/users&#x27;);</span><br><span class="line">const productRouter = require(&#x27;./routers/products&#x27;);</span><br><span class="line"></span><br><span class="line">const app = express();</span><br><span class="line"></span><br><span class="line">app.use(&quot;/users&quot;, userRouter);</span><br><span class="line">app.use(&quot;/products&quot;, productRouter);</span><br><span class="line"></span><br><span class="line">app.listen(8000, () =&gt; &#123;</span><br><span class="line">  console.log(&quot;路由服务器启动成功~&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">routers/users</span><br><span class="line">/**</span><br><span class="line"> * 举个例子:</span><br><span class="line"> *   请求所有的用户信息: get /users</span><br><span class="line"> *   请求所有的某个用户信息: get /users/:id</span><br><span class="line"> *   请求所有的某个用户信息: post /users body &#123;username: passwod:&#125;</span><br><span class="line"> *   请求所有的某个用户信息: delete /users/:id </span><br><span class="line"> *   请求所有的某个用户信息: patch /users/:id &#123;nickname: &#125;</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">const express = require(&#x27;express&#x27;);</span><br><span class="line"></span><br><span class="line">const router = express.Router();</span><br><span class="line"></span><br><span class="line">router.get(&#x27;/&#x27;, (req, res, next) =&gt; &#123;</span><br><span class="line">  res.json([&quot;why&quot;, &quot;kobe&quot;, &quot;lilei&quot;]);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(&#x27;/:id&#x27;, (req, res, next) =&gt; &#123;</span><br><span class="line">  res.json(`$&#123;req.params.id&#125;用户的信息`);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.post(&#x27;/&#x27;, (req, res, next) =&gt; &#123;</span><br><span class="line">  res.json(&quot;create user success~&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">module.exports = router;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="静态服务器"><a href="#静态服务器" class="headerlink" title="静态服务器"></a>静态服务器</h4><p>express提供了部署静态资源的方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const express = require(&#x27;express&#x27;);</span><br><span class="line"></span><br><span class="line">const app = express();</span><br><span class="line"></span><br><span class="line">app.use(express.static(&#x27;./build&#x27;)); //.build中是打包后的文件 npm run build</span><br><span class="line"></span><br><span class="line">app.listen(8000, () =&gt; &#123;</span><br><span class="line">  console.log(&quot;路由服务器启动成功~&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="express的错误处理"><a href="#express的错误处理" class="headerlink" title="express的错误处理"></a>express的错误处理</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">const express = require(&#x27;express&#x27;);</span><br><span class="line"></span><br><span class="line">const app = express();</span><br><span class="line"></span><br><span class="line">const USERNAME_DOES_NOT_EXISTS = &quot;USERNAME_DOES_NOT_EXISTS&quot;;</span><br><span class="line">const USERNAME_ALREADY_EXISTS = &quot;USERNAME_ALREADY_EXISTS&quot;;</span><br><span class="line"></span><br><span class="line">app.post(&#x27;/login&#x27;, (req, res, next) =&gt; &#123;</span><br><span class="line">  // 加入在数据中查询用户名时, 发现不存在</span><br><span class="line">  const isLogin = false;</span><br><span class="line">  if (isLogin) &#123;</span><br><span class="line">    res.json(&quot;user login success~&quot;);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    // res.type(400);</span><br><span class="line">    // res.json(&quot;username does not exists~&quot;)</span><br><span class="line">    next(new Error(USERNAME_DOES_NOT_EXISTS));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.post(&#x27;/register&#x27;, (req, res, next) =&gt; &#123;</span><br><span class="line">  // 加入在数据中查询用户名时, 发现不存在</span><br><span class="line">  const isExists = true;</span><br><span class="line">  if (!isExists) &#123;</span><br><span class="line">    res.json(&quot;user register success~&quot;);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    // res.type(400);</span><br><span class="line">    // res.json(&quot;username already exists~&quot;)</span><br><span class="line">    next(new Error(USERNAME_ALREADY_EXISTS));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use((err, req, res, next) =&gt; &#123;</span><br><span class="line">  let status = 400;</span><br><span class="line">  let message = &quot;&quot;;</span><br><span class="line">  console.log(err.message);</span><br><span class="line"></span><br><span class="line">  switch(err.message) &#123;</span><br><span class="line">    case USERNAME_DOES_NOT_EXISTS:</span><br><span class="line">      message = &quot;username does not exists~&quot;;</span><br><span class="line">      break;</span><br><span class="line">    case USERNAME_ALREADY_EXISTS:</span><br><span class="line">      message = &quot;USERNAME_ALREADY_EXISTS~&quot;</span><br><span class="line">      break;</span><br><span class="line">    default: </span><br><span class="line">      message = &quot;NOT FOUND~&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  res.status(status);</span><br><span class="line">  res.json(&#123;</span><br><span class="line">    errCode: status,</span><br><span class="line">    errMessage: message</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(8000, () =&gt; &#123;</span><br><span class="line">  console.log(&quot;路由服务器启动成功~&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>更多细节察看expressjs.com.cn</p>
<h4 id="部分原理"><a href="#部分原理" class="headerlink" title="部分原理"></a>部分原理</h4><p>调用express创建的是什么</p>
<p><img src="https://s1.ax1x.com/2022/09/22/xFY0mT.png"></p>
<p>ap.listen如何结合原生启动服务器</p>
<p>listen在createApplication中表面上看不出来，实际上在mixin(app。proto，false)中</p>
<p>调用了原生的http创建服务器启动监听</p>
<p><img src="https://s1.ax1x.com/2022/09/22/xFYytJ.png"></p>
<p>loading……</p>
<p>app.use发生了什么</p>
<p>用户发送网络请求如何执行中间件回调</p>
<p>next为什么会执行下一个中间件</p>
<h3 id="Koa"><a href="#Koa" class="headerlink" title="Koa"></a>Koa</h3><p>koa自称是node.js的下一代框架，koa是和express同一个团队开发的框架</p>
<p>koa旨在为web应用程序和api提供更小，更丰富和强大的能力</p>
<p>相对于express具有更强大的异步处理能力</p>
<p>koa的核心代码只有一千多行，很清凉</p>
<p>我们可以根据需要考虑安装中间件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">const Koa = require(&#x27;koa&#x27;);</span><br><span class="line"></span><br><span class="line">const app = new Koa();</span><br><span class="line">//ctx = context 上下文对象 包含request和response</span><br><span class="line">app.use((ctx, next) =&gt; &#123;</span><br><span class="line">  ctx.response.body = &quot;Hello World&quot;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(8000, () =&gt; &#123;</span><br><span class="line">  console.log(&quot;koa初体验服务器启动成功~&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="注册中间件"><a href="#注册中间件" class="headerlink" title="注册中间件"></a>注册中间件</h4><p>koa并没有提供methods，path和连续注册的方式注册中间件</p>
<p>只能通过app.use(()&#x3D;&gt;{})</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">const Koa = require(&#x27;koa&#x27;);</span><br><span class="line"></span><br><span class="line">const app = new Koa();</span><br><span class="line"></span><br><span class="line">// use注册中间件</span><br><span class="line">app.use((ctx, next) =&gt; &#123;</span><br><span class="line">  if (ctx.request.url === &#x27;/login&#x27;) &#123;</span><br><span class="line">    if (ctx.request.method === &#x27;GET&#x27;) &#123;</span><br><span class="line">      console.log(&quot;来到了这里~&quot;);</span><br><span class="line">      ctx.response.body = &quot;Login Success~&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    ctx.response.body = &quot;other request~&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// 没有提供下面的注册方式</span><br><span class="line">// methods方式: app.get()/.post</span><br><span class="line">// path方式: app.use(&#x27;/home&#x27;, (ctx, next) =&gt; &#123;&#125;)</span><br><span class="line">// 连续注册: app.use((ctx, next) =&gt; &#123;</span><br><span class="line">// &#125;, (ctx, next) =&gt; &#123;</span><br><span class="line">// &#125;)</span><br><span class="line"></span><br><span class="line">app.listen(8000, () =&gt; &#123;</span><br><span class="line">  console.log(&quot;koa初体验服务器启动成功~&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="路由的使用-1"><a href="#路由的使用-1" class="headerlink" title="路由的使用"></a>路由的使用</h4><p>需要安装第三方库 koa-router</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">const Koa = require(&#x27;koa&#x27;);</span><br><span class="line"></span><br><span class="line">const userRouter = require(&#x27;./router/user&#x27;);</span><br><span class="line"></span><br><span class="line">const app = new Koa();</span><br><span class="line"></span><br><span class="line">app.use((ctx, next) =&gt; &#123;</span><br><span class="line">  // ctx.response.body = &quot;Hello World&quot;;</span><br><span class="line">  next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(userRouter.routes());</span><br><span class="line">app.use(userRouter.allowedMethods()); //如果访问了错误的地址和方式</span><br><span class="line"></span><br><span class="line">app.listen(8000, () =&gt; &#123;</span><br><span class="line">  console.log(&quot;koa路由服务器启动成功~&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">//routers</span><br><span class="line">const Router = require(&#x27;koa-router&#x27;);</span><br><span class="line"></span><br><span class="line">const router = new Router(&#123;prefix: &quot;/users&quot;&#125;);</span><br><span class="line"></span><br><span class="line">router.get(&#x27;/&#x27;, (ctx, next) =&gt; &#123;</span><br><span class="line">  ctx.response.body = &quot;User Lists~&quot;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.put(&#x27;/&#x27;, (ctx, next) =&gt; &#123;</span><br><span class="line">  ctx.response.body = &quot;put request~&quot;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">module.exports = router;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="参数解析query，params"><a href="#参数解析query，params" class="headerlink" title="参数解析query，params"></a>参数解析query，params</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">const Koa = require(&#x27;koa&#x27;);</span><br><span class="line"></span><br><span class="line">const app = new Koa();</span><br><span class="line">const Router = require(&#x27;koa-router&#x27;);</span><br><span class="line"></span><br><span class="line">const userRouter = new Router(&#123;prefix: &#x27;/users&#x27;&#125;);</span><br><span class="line"></span><br><span class="line">userRouter.get(&#x27;/:id&#x27;, (ctx, next) =&gt; &#123;</span><br><span class="line">  console.log(ctx.request.params);</span><br><span class="line">  console.log(ctx.request.query);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// app.use((ctx, next) =&gt; &#123;</span><br><span class="line">//   console.log(ctx.request.url);</span><br><span class="line">//   console.log(ctx.request.query);</span><br><span class="line">//   console.log(ctx.request.params);</span><br><span class="line">//   ctx.response.body = &quot;Hello World&quot;;</span><br><span class="line">// &#125;);</span><br><span class="line"></span><br><span class="line">app.use(userRouter.routes());</span><br><span class="line"></span><br><span class="line">app.listen(8000, () =&gt; &#123;</span><br><span class="line">  console.log(&quot;参数处理服务器启动成功~&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="参数解析urlenclded和formdata"><a href="#参数解析urlenclded和formdata" class="headerlink" title="参数解析urlenclded和formdata"></a>参数解析urlenclded和formdata</h4><p>npm install koa-bodyparser koa-multer</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">const Koa = require(&#x27;koa&#x27;);</span><br><span class="line">const bodyParser = require(&#x27;koa-bodyparser&#x27;); //json,urlencoded</span><br><span class="line">const multer = require(&#x27;koa-multer&#x27;); //form-data</span><br><span class="line">const Router = require(&#x27;koa-router&#x27;);</span><br><span class="line"></span><br><span class="line">const app = new Koa();</span><br><span class="line"></span><br><span class="line">const upload = multer();</span><br><span class="line"></span><br><span class="line">app.use(bodyParser());</span><br><span class="line">app.use(upload.any());</span><br><span class="line"></span><br><span class="line">app.use((ctx, next) =&gt; &#123;</span><br><span class="line">  console.log(ctx.request.body);</span><br><span class="line">  console.log(ctx.req.body); //multer塞进去的</span><br><span class="line">  ctx.response.body = &quot;Hello World&quot;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(8000, () =&gt; &#123;</span><br><span class="line">  console.log(&quot;koa初体验服务器启动成功~&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">const Koa = require(&#x27;koa&#x27;);</span><br><span class="line">const Router = require(&#x27;koa-router&#x27;);</span><br><span class="line">const multer = require(&#x27;koa-multer&#x27;);</span><br><span class="line"></span><br><span class="line">const app = new Koa();</span><br><span class="line">const uploadRouter = new Router(&#123;prefix: &#x27;/upload&#x27;&#125;);</span><br><span class="line"></span><br><span class="line">// const storage = multer.diskStorage(&#123;</span><br><span class="line">//   destination,</span><br><span class="line">//   filename,</span><br><span class="line">// &#125;)</span><br><span class="line"></span><br><span class="line">const upload = multer(&#123;</span><br><span class="line">  dest: &#x27;./uploads/&#x27;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">uploadRouter.post(&#x27;/avatar&#x27;, upload.single(&#x27;avatar&#x27;), (ctx, next) =&gt; &#123;</span><br><span class="line">  console.log(ctx.req.file);</span><br><span class="line">  ctx.response.body = &quot;上传头像成功~&quot;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(uploadRouter.routes());</span><br><span class="line"></span><br><span class="line">app.listen(8000, () =&gt; &#123;</span><br><span class="line">  console.log(&quot;koa初体验服务器启动成功~&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="koa响应内容"><a href="#koa响应内容" class="headerlink" title="koa响应内容"></a>koa响应内容</h4><p>body将相应主体分为</p>
<p>string</p>
<p>Buffer</p>
<p>Stream</p>
<p>Object&#x2F;Array</p>
<p>null</p>
<p>如果response.status未设置，koa自动设置状态为200或者204  &#x2F;&#x2F;有内容200，没内容返回null和204</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">const Koa = require(&#x27;koa&#x27;);</span><br><span class="line"></span><br><span class="line">const app = new Koa();</span><br><span class="line"></span><br><span class="line">app.use((ctx, next) =&gt; &#123;</span><br><span class="line">  // ctx.request.query</span><br><span class="line">  // ctx.query</span><br><span class="line"></span><br><span class="line">  // 设置内容</span><br><span class="line">  // ctx.response.body</span><br><span class="line">  // ctx.response.body = &quot;Hello world~&quot;</span><br><span class="line">  // ctx.response.body = &#123;</span><br><span class="line">  //   name: &quot;coderwhy&quot;,</span><br><span class="line">  //   age: 18,</span><br><span class="line">  //   avatar_url: &quot;https://abc.png&quot;</span><br><span class="line">  // &#125;;</span><br><span class="line">  // 设置状态码</span><br><span class="line">  // ctx.response.status = 400;</span><br><span class="line">  // ctx.response.body = [&quot;abc&quot;, &quot;cba&quot;, &quot;nba&quot;];</span><br><span class="line"></span><br><span class="line">  // ctx.response.body = &quot;Hello World~&quot;;</span><br><span class="line">  ctx.status = 404;</span><br><span class="line">  ctx.body = &quot;Hello Koa~&quot;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(8000, () =&gt; &#123;</span><br><span class="line">  console.log(&quot;koa初体验服务器启动成功~&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="部署静态资源"><a href="#部署静态资源" class="headerlink" title="部署静态资源"></a>部署静态资源</h4><p>npm Install koa-static</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">const Koa = require(&#x27;koa&#x27;);</span><br><span class="line">const staticAssets = require(&#x27;koa-static&#x27;);</span><br><span class="line"></span><br><span class="line">const app = new Koa();</span><br><span class="line"></span><br><span class="line">app.use(staticAssets(&#x27;./build&#x27;));</span><br><span class="line"></span><br><span class="line">app.listen(8000, () =&gt; &#123;</span><br><span class="line">  console.log(&quot;koa初体验服务器启动成功~&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">const Koa = require(&#x27;koa&#x27;);</span><br><span class="line"></span><br><span class="line">const app = new Koa();</span><br><span class="line"></span><br><span class="line">app.use((ctx, next) =&gt; &#123;</span><br><span class="line">  const isLogin = false;</span><br><span class="line">  if (!isLogin) &#123;</span><br><span class="line">    ctx.app.emit(&#x27;error&#x27;, new Error(&quot;您还没有登录~&quot;), ctx);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.on(&#x27;error&#x27;, (err, ctx) =&gt; &#123;</span><br><span class="line">  ctx.status = 401;</span><br><span class="line">  ctx.body = err.message;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(8000, () =&gt; &#123;</span><br><span class="line">  console.log(&quot;koa初体验服务器启动成功~&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="express和koa的区别"><a href="#express和koa的区别" class="headerlink" title="express和koa的区别"></a>express和koa的区别</h3><p>express比较完整，koa比较自由简洁只包含核心功能，我们需要自己安装使用</p>
<p>两者核心都是中间件</p>
<h4 id="express同步数据"><a href="#express同步数据" class="headerlink" title="express同步数据"></a>express同步数据</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">const express = require(&#x27;express&#x27;);</span><br><span class="line"></span><br><span class="line">const app = express();</span><br><span class="line"></span><br><span class="line">const middleware1 = (req, res, next) =&gt; &#123;</span><br><span class="line">  req.message = &quot;aaa&quot;;</span><br><span class="line">  next();</span><br><span class="line">  res.end(req.message);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const middleware2 = (req, res, next) =&gt; &#123;</span><br><span class="line">  req.message += &quot;bbb&quot;;</span><br><span class="line">  next();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const middleware3 = (req, res, next) =&gt; &#123;</span><br><span class="line">  req.message += &quot;ccc&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.use(middleware1, middleware2, middleware3);</span><br><span class="line"></span><br><span class="line">app.listen(8000, () =&gt; &#123;</span><br><span class="line">  console.log(&quot;服务器启动成功~&quot;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="express异步数据"><a href="#express异步数据" class="headerlink" title="express异步数据"></a>express异步数据</h4><p>express处理异步数据非常麻烦，只能单独抽离函数await</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">const express = require(&#x27;express&#x27;);</span><br><span class="line">const axios = require(&#x27;axios&#x27;);</span><br><span class="line"></span><br><span class="line">const app = express();</span><br><span class="line"></span><br><span class="line">const middleware1 = async (req, res, next) =&gt; &#123;</span><br><span class="line">  req.message = &quot;aaa&quot;;</span><br><span class="line">  await next();</span><br><span class="line">  res.end(req.message);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const middleware2 = async (req, res, next) =&gt; &#123;</span><br><span class="line">  req.message += &quot;bbb&quot;;</span><br><span class="line">  await next();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const middleware3 = async (req, res, next) =&gt; &#123;</span><br><span class="line">  const result = await axios.get(&#x27;http://123.207.32.32:9001/lyric?id=167876&#x27;);</span><br><span class="line">  req.message += result.data.lrc.lyric;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.use(middleware1, middleware2, middleware3);</span><br><span class="line"></span><br><span class="line">app.listen(8000, () =&gt; &#123;</span><br><span class="line">  console.log(&quot;服务器启动成功~&quot;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<h4 id="koa同步数据"><a href="#koa同步数据" class="headerlink" title="koa同步数据"></a>koa同步数据</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">const Koa = require(&#x27;koa&#x27;);</span><br><span class="line"></span><br><span class="line">const app = new Koa();</span><br><span class="line"></span><br><span class="line">const middleware1 = (ctx, next) =&gt; &#123;</span><br><span class="line">  ctx.message = &quot;aaa&quot;;</span><br><span class="line">  next();</span><br><span class="line">  ctx.body = ctx.message;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const middleware2 = (ctx, next) =&gt; &#123;</span><br><span class="line">  ctx.message += &quot;bbb&quot;;</span><br><span class="line">  next();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const middleware3 = (ctx, next) =&gt; &#123;</span><br><span class="line">  ctx.message += &quot;ccc&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.use(middleware1);</span><br><span class="line">app.use(middleware2);</span><br><span class="line">app.use(middleware3);</span><br><span class="line"></span><br><span class="line">app.listen(8000, () =&gt; &#123;</span><br><span class="line">  console.log(&quot;服务器启动成功~&quot;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<h4 id="koa异步数据"><a href="#koa异步数据" class="headerlink" title="koa异步数据"></a>koa异步数据</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">const Koa = require(&#x27;koa&#x27;);</span><br><span class="line">const axios = require(&#x27;axios&#x27;);</span><br><span class="line"></span><br><span class="line">const app = new Koa();</span><br><span class="line"></span><br><span class="line">const middleware1 = async (ctx, next) =&gt; &#123;</span><br><span class="line">  ctx.message = &quot;aaa&quot;;</span><br><span class="line">  await next();</span><br><span class="line">  next();</span><br><span class="line">  ctx.body = ctx.message;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const middleware2 = async (ctx, next) =&gt; &#123;</span><br><span class="line">  ctx.message += &quot;bbb&quot;;</span><br><span class="line">  await next();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const middleware3 = async (ctx, next) =&gt; &#123;</span><br><span class="line">  const result = await axios.get(&#x27;http://123.207.32.32:9001/lyric?id=167876&#x27;);</span><br><span class="line">  ctx.message += result.data.lrc.lyric;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.use(middleware1);</span><br><span class="line">app.use(middleware2);</span><br><span class="line">app.use(middleware3);</span><br><span class="line"></span><br><span class="line">app.listen(8000, () =&gt; &#123;</span><br><span class="line">  console.log(&quot;服务器启动成功~&quot;);</span><br><span class="line">&#125;) </span><br></pre></td></tr></table></figure>

<h3 id="洋葱模型"><a href="#洋葱模型" class="headerlink" title="洋葱模型"></a>洋葱模型</h3><p>……</p>
<p>学无止境，结束意味着新的开始</p>
<p>loading……</p>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2022/05/30/Node5/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>上一页</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime" title="更新时间"></i>
              2022-06-04 01:47:14
            </span>
            
                  <span class="post-tags">
                    <i class="iconfont icon-tags" title="标签"></i>
                    
                    <span class="span--tag">
                      <a href="/tags/Node%E5%AD%A6%E4%B9%A0/" title="Node学习">
                        <b>#</b> Node学习
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
              <a href="/2022/06/12/websocket1/" target="_self">
                <span>下一页</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">目录</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#http%E5%86%85%E7%BD%AE%E6%A8%A1%E5%9D%97%EF%BC%8CNode%E6%A1%86%E6%9E%B6Express%E5%92%8CKoa"><span class="toc-text">http内置模块，Node框架Express和Koa</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#http%E6%A8%A1%E5%9D%97"><span class="toc-text">http模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#req"><span class="toc-text">req</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#res"><span class="toc-text">res</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#http%E5%8F%91%E9%80%81%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82"><span class="toc-text">http发送网络请求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#http%E6%96%B9%E5%BC%8F%E5%8E%9F%E7%94%9F%E7%9A%84%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-text">http方式原生的文件上传</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Express"><span class="toc-text">Express</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-text">基本使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%94%A8%E6%B3%95"><span class="toc-text">中间件用法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#json%E8%A7%A3%E6%9E%90"><span class="toc-text">json解析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#formdata%E8%A7%A3%E6%9E%90"><span class="toc-text">formdata解析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#formdata%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6"><span class="toc-text">formdata上传文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%9D%E5%AD%98%E6%97%A5%E5%BF%97%E4%BF%A1%E6%81%AF"><span class="toc-text">保存日志信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#request%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90"><span class="toc-text">request参数解析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#response%E5%93%8D%E5%BA%94%E7%BB%93%E6%9E%9C%E8%A7%A3%E6%9E%90"><span class="toc-text">response响应结果解析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-text">路由的使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-text">静态服务器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#express%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-text">express的错误处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%83%A8%E5%88%86%E5%8E%9F%E7%90%86"><span class="toc-text">部分原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Koa"><span class="toc-text">Koa</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-text">注册中间件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E7%9A%84%E4%BD%BF%E7%94%A8-1"><span class="toc-text">路由的使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90query%EF%BC%8Cparams"><span class="toc-text">参数解析query，params</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90urlenclded%E5%92%8Cformdata"><span class="toc-text">参数解析urlenclded和formdata</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-text">文件上传</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#koa%E5%93%8D%E5%BA%94%E5%86%85%E5%AE%B9"><span class="toc-text">koa响应内容</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90"><span class="toc-text">部署静态资源</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-text">错误处理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#express%E5%92%8Ckoa%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-text">express和koa的区别</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#express%E5%90%8C%E6%AD%A5%E6%95%B0%E6%8D%AE"><span class="toc-text">express同步数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#express%E5%BC%82%E6%AD%A5%E6%95%B0%E6%8D%AE"><span class="toc-text">express异步数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#koa%E5%90%8C%E6%AD%A5%E6%95%B0%E6%8D%AE"><span class="toc-text">koa同步数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#koa%E5%BC%82%E6%AD%A5%E6%95%B0%E6%8D%AE"><span class="toc-text">koa异步数据</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B4%8B%E8%91%B1%E6%A8%A1%E5%9E%8B"><span class="toc-text">洋葱模型</span></a></li></ol></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        







      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          <a title="github" href="git@github.com:222cabbage/222cabbage.github.io.git">
            <i class="iconfont icon-github"></i>
          </a>
        </li>
      
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a href="git@github.com:222cabbage/222cabbage.github.io.git">Copyright © 2024 222cabbage</a>
        
    </div>
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="搜索...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>首次搜索，正在载入索引文件，请稍后……<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>没有找到内容，请尝试更换检索词。<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>未找到search.xml文件，具体请参考：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>请求失败，尝试重新刷新页面或稍后重试。<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        
  
    <div class="share-icon tools-bar-item">
      <a href="javascript: void(0)" id="share-icon">
        <i class="iconfont iconshare"></i>
      </a>
      <div class="share-content hidden">
        
          <a class="share-item" href="https://twitter.com/intent/tweet?text=' + http%E5%86%85%E7%BD%AE%E6%A8%A1%E5%9D%97%EF%BC%8CExpress%E5%92%8CKoa + '&url=' + https%3A%2F%2F222cabbage.github.io%2F2022%2F06%2F04%2FNode6%2F + '" target="_blank" title="Twitter">
            <i class="iconfont icon-twitter"></i>
          </a>
        
        
          <a class="share-item" href="https://www.facebook.com/sharer.php?u=https://222cabbage.github.io/2022/06/04/Node6/" target="_blank" title="Facebook">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        
      </div>
    </div>
  
  
<script src="/js/shares.js"></script>



      </div>
    </div>
  <script async>window.onload=function(){var a=document.createElement('script'),b=document.getElementsByTagName('script')[0];a.type='text/javascript',a.async=!0,a.src='/sw-register.js?v='+Date.now(),b.parentNode.insertBefore(a,b)};</script></body></html>